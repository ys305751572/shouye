package com.smallchill.web.service.impl;

import com.smallchill.api.common.exception.UserHasApprovalException;
import com.smallchill.api.common.exception.UserHasJoinGroupException;
import com.smallchill.api.common.exception.UserInOthersBlankException;
import com.smallchill.core.toolbox.Record;
import com.smallchill.core.toolbox.kit.DateTimeKit;
import com.smallchill.web.model.GroupApproval;
import com.smallchill.web.service.GroupApprovalService;
import com.smallchill.web.service.GroupService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import com.smallchill.core.base.service.BaseService;

/**
 * 组织审核
 * Generated by yesong.
 * 2016-10-27 11:45:35
 */
@Service
public class GroupApprovalServiceImpl extends BaseService<GroupApproval> implements GroupApprovalService {

    @Autowired
    private GroupService groupService;

    /**
     * 是否已经申请
     *
     * @param ga 申请信息
     * @return 结果
     */
    public boolean isApprival(GroupApproval ga) throws UserHasApprovalException, UserHasJoinGroupException, UserInOthersBlankException {
        String sql = "select status from tb_group_approval where group_id = #{groupId} and user_id = #{userId}";
        Record record = Record.create();
        record.put("groupId", ga.getGroupId());
        record.put("userId", ga.getUserId());
        GroupApproval groupApproval = this.findFirst(sql, record);
        if (groupApproval == null) return false;
        if (groupApproval.getStatus() == 2) {
            groupService.audit(ga.getGroupId(), ga.getUserId(), 0);
            return true;
        }
        if (groupApproval.getStatus() == 0) {
            throw new UserHasApprovalException();
        }
        if (groupApproval.getStatus() == 1 || groupApproval.getStatus() == 4) {
            throw new UserHasJoinGroupException();
        }
        if (groupApproval.getStatus() == 3) {
            throw new UserInOthersBlankException();
        }
        return false;
    }

    @Override
    public void join(GroupApproval ga) throws UserInOthersBlankException, UserHasApprovalException, UserHasJoinGroupException {
        // 是否已经发送申请
        if (!isApprival(ga)) {
            ga.setCreateTime(DateTimeKit.nowLong());
            save1(ga);
        }
    }

    /**
     * 新增申请记录
     *
     * @param ga 申请信息
     */
    private void save1(GroupApproval ga) {
        this.save(ga);
    }
}
