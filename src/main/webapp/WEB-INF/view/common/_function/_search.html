<div class="wellsearch well-sm" id="searchfield" xmlns:c="http://www.w3.org/1999/XSL/Transform">
    <div class="col-xs-8 input-group">

        @for(x in col){
        <input type="hidden" id="size" value="${xLP.size}">
        <div class="input-group-btn" id="search">
            <input data-toggle="dropdown"
                   class="btn btn-sx btn-white dropdown-toggle" disabled="disabled" id="searchthis${xLP.index}"
                   value="${x.name!}" style="width: 90px;margin-left: 10px;">
            <input type="hidden" id="key" value="${x.index!}">
            <input type="hidden" id="type" value="${x.type!}">
            <input type="hidden" id="index" value="${xLP.index}">
        </div>

        <div id="divinput${xLP.index }">
            <input type="text" id="inputs${xLP.index }" class="form-control" style="margin:10px 10px 0 0;width: auto"/>
        </div>
        <input type="hidden" id="hides${xLP.index }"/>

        <span class="input-group-btn"></span>
        @}
    </div>

    <div class="col-xs-8 input-group">
        <!--简单查询按钮-->
        <div class="input-group-btn">
            <input type="text" id="add" class="form-control" style="margin:10px 10px 0 10px;width: auto"/>
            <button class="btn btn-sx btn-white" id="gotoSearch" onclick="" style="margin:10px 10px 0 0;">添加</button>
        </div>
    </div>

</div>

<div class="welljq well-sm" id="tags" style="padding: 2px;">
    <span style="float: left">已添加筛选条件:</span>
</div>

<script type="text/javascript">
    var isAutoPage = true;
    var size = $("#size").val();
    $(function () {

        //列隐藏
        $("#columns input").click(function () {
            var _this = $(this);
            var width = $(grid_selector).getGridParam('width');
            if (_this.prop('checked')) {
                $(grid_selector).setGridParam().showCol(_this.val()).trigger("reloadGrid");
                $(grid_selector).setGridWidth(width);
            }
            else {
                $(grid_selector).setGridParam().hideCol(_this.val()).trigger("reloadGrid");
                $(grid_selector).setGridWidth(width);
            }
        });


        //查询模块
        $("div #search").each(function () {
            var name = $(this).find('input').eq(0).val();
            var key = $(this).find('input').eq(1).val();
            var type = $(this).find('input').eq(2).val();
            var index = $(this).find('input').eq(3).val();
            changethis(key, name, type, index);
        });


        /*		$("#gotoSearch").bind("click", function () {
         var key1 = $("#hides3").val();
         var key2 = $("#hides2").val();
         var value1 = $("#inputs3").val();
         var value2 = $("#inputs2").val();
         var filter = "";
         if (typeof (_filter) != "undefined") {
         filter = _filter;
         }
         var where = (BladeTool.isEmpty(filter)) ? "" : filter.replace("}", "");
         if (BladeTool.isNotEmpty(key1) && BladeTool.isNotEmpty(value1)) {
         where += (BladeTool.isEmpty(filter) ? "{" : ",") + "\"" + key1 + "\":\"" + value1 + "\"";
         }
         if (BladeTool.isNotEmpty(key2) && BladeTool.isNotEmpty(value2)) {
         where += (BladeTool.isEmpty(where) ? "{" : ",") + "\"" + key2 + "\":\"" + value2 + "\"";
         }
         if (BladeTool.isNotEmpty(where) && BladeTool.isEmpty(exwhere)) {
         where += "}";
         }
         else if (BladeTool.isNotEmpty(where) && BladeTool.isNotEmpty(exwhere)) {
         where += exwhere.replace("{", ",");
         }
         else {
         where = BladeTool.format(exwhere);
         }
         where = (BladeTool.isEmpty(key1) && BladeTool.isEmpty(key2) && BladeTool.isEmpty(where)) ? "" : encodeURI(where);

         var pageNum = $jqGrid.getGridParam('page');
         $jqGrid.jqGrid("setGridParam", { postData: { where: where }, page: (isAutoPage) ? pageNum : 1 }).trigger("reloadGrid");
         });

         $("#gotoReset").bind("click", function () {
         changethis("", "请选择", "", 1);
         changethis("", "请选择", "", 2);
         btn_stage.bind(toolbar);
         reloadGrid();
         });*/
    });

    //下拉框
    function select(data, key) {
        var option = "#" + data + " option:selected";
        var id = "#" + data;
        $(id).change(function () {
            var val = $(option).val();
            var text = $(option).text();
            tags(data, val, text, key)
        });
    }

    //标签
    function tags(id, val, text, key) {
        console.log("id:" + id);
        var html = "";
        html += "<div id='" + id + "' class='o_choose' data-type='' style='background: #666;color: white;float: left;position: relative;font-size: 10px;width: auto;text-indent: 10px;margin:0 5px 0 0'>" + text;
        html += "	<span class='o_close' data-percent='' onclick='doDelete(this)' style='cursor: pointer;color: #ccc;margin: 0 5px auto'>x</span>	";
        html += "	<input type='hidden' value='" + val + "'> 	";
        html += "	<input type='hidden' value='" + key + "'> 	";
        html += "</div>   ";

        $("#tags div").each(function () {
            var _id = $(this).prop("id");
            if (id == _id) {
                $(this).remove();
            }
        });
        if (text == '' || text == null) {
            html = '';
        }
        $("#tags").append(html);
        search();
    }

    function doDelete(btn) {
        $(btn).parent().remove();
        search();
    }

    //查询
    function search() {
        var myMap = new Map();
        $("#tags div").each(function () {
            var id = $(this).prop("id");
            var value = $(this).find("input").eq(0).val();
            var key = $(this).find("input").eq(1).val();
            myMap.set(key, value);

        });

        var filter = "";
        if (typeof (_filter) != "undefined") {
            filter = _filter;
        }
        var where = (BladeTool.isEmpty(filter)) ? "" : filter.replace("}", "");
        var index = 1;

//        console.log("------------------------search---------------------------------");
//        console.log("---where1---");
//        console.log(where);

        myMap.forEach(function (value, key) {
            console.log(index);
            if (BladeTool.isNotEmpty(key) && BladeTool.isNotEmpty(value)) {
                if (index == 1) {
                    where += (BladeTool.isEmpty(filter) ? "{" : ",") + "\"" + key + "\":\"" + value + "\"";
                } else {
                    where += (BladeTool.isEmpty(where) ? "{" : ",") + "\"" + key + "\":\"" + value + "\"";
                }
                index++;
            }
        });

//        console.log("---where2---");
//        console.log(where);

        if (BladeTool.isNotEmpty(where) && BladeTool.isEmpty(exwhere)) {
            where += "}";
        }
        else if (BladeTool.isNotEmpty(where) && BladeTool.isNotEmpty(exwhere)) {
            where += exwhere.replace("{", ",");
        }
        else {
            where = BladeTool.format(exwhere);
        }
//        console.log("---where3---");
//        console.log(where);

        var chk = 1;

        myMap.forEach(function (value, key) {
            if (BladeTool.isEmpty(key)) {
                chk = 2;
            }
        });

        if (chk == 2 && BladeTool.isEmpty(where)) {
            where = "";
        } else {
            where = encodeURI(where);
        }

//		where = (BladeTool.isEmpty(key1) && BladeTool.isEmpty(key2) && BladeTool.isEmpty(where)) ? "" : encodeURI(where);

        var pageNum = $jqGrid.getGridParam('page');
        $jqGrid.jqGrid("setGridParam", {
            postData: {where: where},
            page: (isAutoPage) ? pageNum : 1
        }).trigger("reloadGrid");
//        console.log("---where4---");
//        console.log(where);
//        console.log("------------------------end---------------------------------")
    }

    function changethis(key, value, type, num) {
        isAutoPage = false;
        if (BladeTool.isEmpty(key)) {
            resetInput(num);
        }
        if (type.indexOf("select_") >= 0) {
            var code = type.replace("select_", "");
            $.post("${basePath}/cache/getSelect", {code: code, num: num}, function (data) {
                if (data.code === 0) {
                    $("#divinput" + num).html(data.data);
                }
                var id = $(data.data).prop("id");
                select(id, key);
            }, "json");
        }
        else if (type == "selectDept") {
            $.post("${basePath}/cache/getDeptSelect", {num: num}, function (data) {
                if (data.code === 0) {
                    $("#divinput" + num).html(data.data);
                }
                var id = $(data.data).prop("id");
                select(id, key);
            }, "json");
        }
        else if (type == "selectUser") {
            $.post("${basePath}/cache/getUserSelect", {num: num}, function (data) {
                if (data.code === 0) {
                    $("#divinput" + num).html(data.data);
                }
                var id = $(data.data).prop("id");
                select(id, key);
            }, "json");
        }
        else if (type == "selectRole") {
            $.post("${basePath}/cache/getRoleSelect", {num: num}, function (data) {
                if (data.code === 0) {
                    $("#divinput" + num).html(data.data);
                }
                var id = $(data.data).prop("id");
                select(id, key);
            }, "json");
        }
        else if (type.indexOf("opentree_") >= 0) {
            var html = "<input type=\"text\"  id=\"inputs" + num + "_INPUT\" class=\"form-control\" style=\"margin-left:-3px;\"/>";
            html += "<input type=\"hidden\"  id=\"inputs" + num + "\" />";
            $("#divinput" + num).html(html);

            $("#inputs" + num + "_INPUT").bind("click", function () {
                openTree(type, "inputs" + num, "请选择");
            });
        }
        else if (type == "date") {
            $("#divinput" + num).html("<input type=\"datetime-local\"  id=\"inputs" + num + "\" class=\"form-control\" style=\"margin-left:-3px;\"/>");
        }
        else if (type == "text") {
            resetInput(num);
        }
        $("#hides" + num).val(key);
        $("#searchthis" + num).html(value);
    }


    function resetInput(num) {
        $("#divinput" + num).html("<input type=\"text\"  id=\"inputs" + num + "\" class=\"form-control\" style=\"margin-left:-3px;\"/>");
    }

    function openTree(type, index, name) {
        layer.open({
            type: 2,
            title: "树形选择",
            area: ["250", "420px"],
            fix: false, //不固定
            maxmin: true,
            content: "${basePath}/ztree/open/" + type + "/" + index + "/" + name + "/0/radio/0"
        });
    }

</script>